generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id          String      @id @default(uuid()) @db.Uuid
  fullName    String
  phone       String      @unique
  email       String?
  city        String?
  notes       String?
  franchiseId String      @db.Uuid
  createdAt   DateTime    @default(now())
  updatedAt   DateTime
  Franchise   Franchise   @relation(fields: [franchiseId], references: [id])
  Trip        Trip[]
  TripReviews TripReview[]
  Complaints  Complaint[]
}




enum TransmissionType {
  MANUAL
  AUTOMATIC
  EV
}

enum CarCategory {
  NORMAL
  PREMIUM
  LUXURY
  SPORTS
}


model Driver {
  id                       String           @id @default(uuid()) @db.Uuid
  franchiseId              String           @db.Uuid
  firstName                String
  lastName                 String
  phone                    String           @unique
  email                    String           @unique
  altPhone                 String?
  driverCode               String           @unique
  password                 String // hashed password for web login
  emergencyContactName     String
  emergencyContactPhone    String
  emergencyContactRelation String
  address                  String
  city                     String
  state                    String
  pincode                  String
  licenseNumber            String
  licenseExpDate           DateTime
  licenseType              String?
  employmentType           DriverEmploymentType? // New field for employment type
  bankAccountName          String
  bankAccountNumber        String
  bankIfscCode             String
  aadharCard               Boolean          @default(false)
  license                  Boolean          @default(false)
  educationCert            Boolean          @default(false)
  previousExp              Boolean          @default(false)
  transmissionTypes TransmissionType[] @default([])
 carCategories     CarCategory[] @default([])
  carTypes                 String // JSON array of CarType enum values
  status                   DriverStatus     @default(ACTIVE)
  driverTripStatus         DriverTripStatus @default(AVAILABLE)
  complaintCount           Int              @default(0)
  warningCount             Int              @default(0) // Complaints resolved with WARNING; 2+ triggers auto-fire
  blacklisted              Boolean          @default(false) // Fired due to complaint; cannot register or login
  bannedGlobally           Boolean          @default(false)
  dailyTargetAmount        Int?
  remainingDailyLimit      Decimal?         @db.Decimal(10, 2) // Remaining daily limit (reduces as trips complete)
  cashInHand               Decimal          @default(0) @db.Decimal(10, 2) // Cash amount in driver's hand
  incentive                Decimal?         @db.Decimal(10, 2) // Incentive amount (e.g. daily/monthly)
  bonus                    Decimal?         @db.Decimal(10, 2) // Bonus amount
  currentRating            Float?
  // Live driver location (updated by driver mobile app while on-duty)
  currentLat               Float?
  currentLng               Float?
  locationAccuracyM        Float?
  locationUpdatedAt        DateTime?
  onlineStatus             Boolean          @default(false)
  lastStatusChange         DateTime?
  isActive                 Boolean          @default(true)
  createdBy                String?          @db.Uuid // User ID who created this driver
  createdAt                DateTime         @default(now())
  updatedAt                DateTime         @updatedAt
  Trip                     Trip[]
  TripOffers               TripOffer[]
  Complaints               Complaint[]
  Warnings                 Warning[]
  Attendances              Attendance[]
  LeaveRequests            LeaveRequest[]
  DriverRatings            DriverRating[]
  TripReviews              TripReview[]
  ActivityLogs             ActivityLog[]
  DriverDailyMetrics       DriverDailyMetrics[]
  TripStatusHistories      TripStatusHistory[]
  DriverTransactions       DriverTransaction[]
}

model Franchise {
  id                      String          @id @default(uuid()) @db.Uuid
  code                    String          @unique
  name                    String
  city                    String // Keep for backward compatibility
  region                  String? // New field
  averageRating           Float?
  address                 String? // Physical address
  phone                   String? // Franchise contact number
  email                   String? // Franchise contact email
  inchargeName            String? // Manager name (stored for backward compatibility)
  storeImage              String? // Store image URL (optional)
  legalDocumentsCollected Boolean         @default(false) // Legal documents collected flag
  status                  FranchiseStatus @default(ACTIVE) // Franchise status
  isActive                Boolean         @default(true)
  createdAt               DateTime        @default(now())
  updatedAt               DateTime        @updatedAt
  Customer                Customer[]
  // Driver relation commented out temporarily to allow dummy UUIDs
  // Driver    Driver[]
  Trip                    Trip[]
  TripReviews             TripReview[]
  ActivityLogs            ActivityLog[]
  Staff                   Staff[]
}

model Role {
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  id          String   @id @default(uuid()) @db.Uuid
}

model Staff {
  id                       String         @id @default(uuid()) @db.Uuid
  name                     String
  phone                    String         @unique
  password                 String
  franchiseId              String         @db.Uuid
  monthlySalary            Decimal        @db.Decimal(10, 2)
  address                  String
  emergencyContact         String
  emergencyContactRelation String
  profilePic               String?
  isActive                 Boolean        @default(true)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime
  govtId                   Boolean        @default(false)
  addressProof             Boolean        @default(false)
  certificates             Boolean        @default(false)
  previousExperienceCert   Boolean        @default(false)
  email                    String         @unique
  status                   StaffStatus    @default(ACTIVE)
  warningCount             Int            @default(0) // Complaints resolved with WARNING; 2+ triggers auto-fire
  suspendedUntil           DateTime?
  onlineStatus             Boolean        @default(false)
  lastStatusChange         DateTime?
  joinDate                 DateTime       @default(now())
  relieveDate              DateTime?
  relieveReason            RelieveReason?
  StaffHistory             StaffHistory[]
  Complaints               Complaint[]
  Warnings                 Warning[]
  Attendances              Attendance[]
  LeaveRequests            LeaveRequest[]
  ActivityLog              ActivityLog[]
  Franchise                Franchise      @relation(fields: [franchiseId], references: [id])

  @@index([franchiseId, isActive])
  @@index([franchiseId, status])
}

model StaffHistory {
  id          String   @id @default(uuid()) @db.Uuid
  staffId     String   @db.Uuid
  action      String
  description String?
  changedBy   String?
  oldValue    String?
  newValue    String?
  createdAt   DateTime @default(now())
  Staff       Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([staffId])
}

model Trip {
  franchiseId          String         @db.Uuid
  driverId             String?        @db.Uuid
  customerId           String?   @db.Uuid
  customerName         String
  customerPhone        String
  tripType             String // Changed from TripType enum to String to support dynamic trip types from TripTypeConfig
  status               TripStatus     @default(NOT_ASSIGNED)
  pickupLocation       String
  pickupLat            Float?
  pickupLng            Float?
  dropLocation         String?
  dropLat              Float?
  dropLng              Float?
  // Destination coordinates (alias for dropLat/dropLng for clarity)
  destinationLat       Float?
  destinationLng       Float?
  scheduledAt          DateTime?
  startedAt            DateTime?
  endedAt              DateTime?
  startTime            DateTime? // Time when driver initiated trip start
  endTime              DateTime? // Time when driver initiated trip end
  startOtp             String?
  endOtp               String?
  baseAmount           Int
  extraAmount          Int            @default(0)
  totalAmount          Int
  finalAmount          Int
  isAmountOverridden   Boolean        @default(false)
  overrideReason       String?
  paymentStatus        PaymentStatus  @default(PENDING)
  paymentMode          PaymentMode?
  paymentReference     String?
  createdAt            DateTime       @default(now())
  updatedAt            DateTime
  alternativePhone     String?
  carType              String?
  carGearType          String?
  customerEmail        String?
  dropLocationNote     String?
  isDetailsReconfirmed Boolean        @default(false)
  isFareDiscussed      Boolean        @default(false)
  isPriceAccepted      Boolean        @default(false)
  pickupLocationNote   String?
  id                   String         @id @default(uuid()) @db.Uuid
  tripPlacedDate       DateTime       @default(now())
  createdBy            String?        @db.Uuid
  dropAddress          String?
  pickupAddress        String?
  // Odometer and car images for trip start/end
  startOdometer        Float?
  endOdometer          Float?
  carImageFront        String? // URL to front car image
  carImageBack         String? // URL to back car image
  // Driver selfie and odometer images
  driverSelfieUrl      String? // URL to driver selfie image
  odometerStartImageUrl String? // URL to odometer start image
  odometerEndImageUrl  String? // URL to odometer end image
  // Live location coordinates
  liveLocationLat      Float? // Live location latitude
  liveLocationLng      Float? // Live location longitude
  User                 User?          @relation(fields: [createdBy], references: [id])
  Customer             Customer?      @relation(fields: [customerId], references: [id])
  Driver               Driver?        @relation(fields: [driverId], references: [id])
  Franchise            Franchise      @relation(fields: [franchiseId], references: [id])
  DriverRatings        DriverRating[]
  ActivityLogs         ActivityLog[]
  TripStatusHistories  TripStatusHistory[]
  TripOffers           TripOffer[]
  TripReviews          TripReview[]
  DriverTransactions   DriverTransaction[]
  Complaints           Complaint[]
}

enum TripOfferStatus {
  OFFERED
  ACCEPTED
  REJECTED
  EXPIRED
  CANCELLED
}

model TripOffer {
  id          String          @id @default(uuid()) @db.Uuid
  tripId      String          @db.Uuid
  driverId    String          @db.Uuid
  status      TripOfferStatus @default(OFFERED)
  offeredAt   DateTime        @default(now())
  expiresAt   DateTime
  acceptedAt  DateTime?
  rejectedAt  DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime        @updatedAt

  Trip        Trip            @relation(fields: [tripId], references: [id], onDelete: Cascade)
  Driver      Driver          @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([tripId, driverId])
  @@index([driverId, status, expiresAt])
  @@index([tripId, status])
  @@index([expiresAt])
}

model TripTypeConfig {
  id          String          @id @default(uuid()) @db.Uuid
  name        String          // Trip type name (e.g., "City Round Trip", "Long Distance")
  description String?         // Optional description
  type        TripPricingType // DISTANCE, TIME, SLAB
  carCategory CarCategory     // NORMAL, PREMIUM, LUXURY, SPORTS

  // Base pricing fields
  baseAmount       Float // Base amount
  baseHour         Float? // Base hours included (nullable for slab type)
  baseDistance     Float? // Base distance in km (nullable for time/slab type)
  extraPerHour     Float? // Extra charge per hour
  extraPerHalfHour Float? // Extra charge per 30 minutes
  extraPerDistance Float? // Extra charge per km

  // Slab pricing arrays
  // distanceSlab: [{from: 0, to: 50, price: 1000}, {from: 51, to: 100, price: 1500}, ...]
  // from and to are in km
  distanceSlab Json? // Array of distance slab objects

  // timeSlab: [{from: "00:00", to: "06:00", price: 500}, {from: "06:00", to: "12:00", price: 800}, ...]
  // from and to are time strings
  timeSlab Json? // Array of time slab objects

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([name, carCategory])
  @@index([type])
  @@index([carCategory])
  @@index([name])
}

model User {
  email          String          @unique
  password       String
  fullName       String
  role           UserRole
  isActive       Boolean         @default(true)
  createdAt      DateTime        @default(now())
  updatedAt      DateTime        @updatedAt
  phone          String?
  id             String          @id @default(uuid()) @db.Uuid
  failedAttempts Int             @default(0)
  lockedUntil    DateTime?
  franchiseId    String?         @db.Uuid // For MANAGER role to associate with franchise
  Trip           Trip[]
  ActivityLogs   ActivityLog[]
  Attendances    Attendance[]
  LeaveRequests  LeaveRequest[]
  TripStatusHistories TripStatusHistory[]
  CreatedWarnings Warning[] // Warnings created by this user
  AppliedTransactions DriverTransaction[] @relation("AppliedTransactions")

  @@index([lockedUntil])
  @@index([franchiseId])
  @@index([role, franchiseId])
}

model DriverEarningsConfig {
  id                    String   @id @default(uuid()) @db.Uuid
  // Scope: null = global, franchiseId set = franchise-level, driverId set = driver-level
  franchiseId           String?  @db.Uuid
  driverId              String?  @db.Uuid
  // Daily incentive config
  dailyTargetDefault    Int      @default(1250) // Default daily target
  incentiveTier1Min     Int      @default(1250) // Min amount for tier 1
  incentiveTier1Max     Int      @default(1550) // Max amount for tier 1
  incentiveTier1Type    String   @default("full_extra") // "full_extra" or "percent"
  incentiveTier2Min     Int      @default(1550) // Min amount for tier 2
  incentiveTier2Percent Int      @default(20) // Percentage for tier 2 (e.g., 20%)
  // Monthly bonus config (stored as JSON array)
  monthlyBonusTiers     Json? // [{ minEarnings: 25000, bonus: 3000 }, { minEarnings: 28000, bonus: 500 }, ...]
  // Monthly deduction policy (stored as JSON array)
  monthlyDeductionTiers Json? // [{ maxEarnings: 26000, cutPercent: 25 }, { maxEarnings: 22000, cutPercent: 20 }, ...]
  // Metadata
  isActive              Boolean  @default(true)
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  updatedBy             String?  @db.Uuid // User ID who last updated

  @@index([franchiseId])
  @@index([driverId])
  @@index([franchiseId, driverId])
}

model Complaint {
  id           String            @id @default(uuid()) @db.Uuid
  driverId     String?           @db.Uuid
  staffId      String?           @db.Uuid
  customerId   String?           @db.Uuid // Customer who raised the complaint
  customerName String // Customer name who registered the complaint
  tripId       String?           @db.Uuid // Optional: Trip related to complaint (for drivers)
  title        String
  description  String
  reportedBy   String?           @db.Uuid // User ID who reported the complaint (createdBy)
  status       ComplaintStatus   @default(RECEIVED)
  priority     ComplaintPriority @default(MEDIUM) // Changed from severity to priority
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt
  resolvedAt       DateTime?
  resolvedBy       String?                    @db.Uuid // User ID who resolved the complaint
  resolution       String?
  resolutionAction ComplaintResolutionAction? // WARNING or FIRE when resolved
  resolutionReason String?                    // Reason for the action taken
  Driver           Driver?                    @relation(fields: [driverId], references: [id], onDelete: Cascade)
  Staff       Staff?            @relation(fields: [staffId], references: [id], onDelete: Cascade)
  Customer    Customer?         @relation(fields: [customerId], references: [id], onDelete: SetNull)
  Trip        Trip?             @relation(fields: [tripId], references: [id], onDelete: SetNull)

  @@index([driverId])
  @@index([staffId])
  @@index([customerId])
  @@index([tripId])
  @@index([status])
  @@index([createdAt])
}

model Warning {
  id        String          @id @default(uuid()) @db.Uuid
  driverId  String?         @db.Uuid
  staffId   String?         @db.Uuid
  reason    String
  priority  WarningPriority @default(MEDIUM)
  createdBy String?         @db.Uuid // User ID who created the warning
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt
  Driver    Driver?         @relation(fields: [driverId], references: [id], onDelete: Cascade)
  Staff     Staff?          @relation(fields: [staffId], references: [id], onDelete: Cascade)
  CreatedByUser User?       @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([driverId])
  @@index([staffId])
  @@index([createdAt])
}

model Attendance {
  id        String           @id @default(uuid()) @db.Uuid
  driverId  String?          @db.Uuid
  staffId   String?          @db.Uuid
  userId    String?          @db.Uuid // For managers (User table)
  date      DateTime         @db.Date
  loginTime DateTime?        // Time when user logged in
  clockIn   DateTime?        // Time when user clocked in
  clockOut  DateTime?        // Time when user clocked out
  status    AttendanceStatus @default(PRESENT)
  notes     String?
  
  // Auto-calculated fields for daily aggregation
  firstOnlineAt      DateTime? // First clock-in time of the day
  lastOfflineAt      DateTime? // Last clock-out time of the day
  totalOnlineMinutes Int?      // Total minutes online (sum of all sessions)
  tripsCompleted     Int       @default(0) // Number of trips completed that day
  
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  Driver    Driver?          @relation(fields: [driverId], references: [id], onDelete: Cascade)
  Staff     Staff?           @relation(fields: [staffId], references: [id], onDelete: Cascade)
  User      User?            @relation(fields: [userId], references: [id], onDelete: Cascade)
  sessions  AttendanceSession[]

  @@unique([driverId, date])
  @@unique([staffId, date])
  @@unique([userId, date])
  @@index([date])
  @@index([driverId, date])
  @@index([staffId, date])
  @@index([userId, date], map: "Attendance_userId_date_custom_idx")
}

model AttendanceSession {
  id           String     @id @default(uuid()) @db.Uuid
  attendanceId String     @db.Uuid
  clockIn      DateTime   @default(now())
  clockOut     DateTime?
  notes        String?
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt

  Attendance Attendance @relation(fields: [attendanceId], references: [id], onDelete: Cascade)

  @@index([attendanceId, clockIn])
  @@index([attendanceId, clockOut])
}

model LeaveRequest {
  id              String             @id @default(uuid()) @db.Uuid
  driverId        String?            @db.Uuid
  staffId         String?            @db.Uuid
  userId          String?            @db.Uuid // For managers (User table)
  startDate       DateTime           @db.Date
  endDate         DateTime           @db.Date
  reason          String
  leaveType       LeaveType
  status          LeaveRequestStatus @default(PENDING)
  requestedBy     String?            @db.Uuid // User ID who requested leave
  approvedBy      String?            @db.Uuid // User ID who approved/rejected
  approvedAt      DateTime?
  rejectionReason String?
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  Driver          Driver?            @relation(fields: [driverId], references: [id], onDelete: Cascade)
  Staff           Staff?             @relation(fields: [staffId], references: [id], onDelete: Cascade)
  User            User?              @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([driverId])
  @@index([staffId])
  @@index([userId])
  @@index([status])
  @@index([startDate])
}

enum TripPricingType {
  DISTANCE
  TIME
  SLAB
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  BLOCKED
  TERMINATED
}

enum DriverEmploymentType {
  FULL_TIME
  PART_TIME
  CONTRACT
}

enum DriverTripStatus {
  AVAILABLE
  ON_TRIP
}

enum PaymentMode {
  UPI
  IN_HAND
  // Legacy payment modes for backward compatibility
  CASH
  CARD
  OTHER
}

enum PaymentStatus {
  PENDING
  COMPLETED
  // Legacy statuses for backward compatibility
  PAID
  PARTIALLY_PAID
}

enum RelieveReason {
  RESIGNATION
  TERMINATION
  RETIREMENT
  CONTRACT_ENDED
  PERFORMANCE_ISSUES
  MISCONDUCT
  OTHER
}

enum StaffStatus {
  ACTIVE
  FIRED
  SUSPENDED
  BLOCKED
}

enum TripStatus {
  NOT_ASSIGNED
  ASSIGNED
  TRIP_STARTED
  TRIP_PROGRESS
  TRIP_ENDED
  COMPLETED
  PAYMENT_DONE
  // Legacy statuses for backward compatibility
  REQUESTED
  DRIVER_ON_THE_WAY
  IN_PROGRESS
  CANCELLED_BY_CUSTOMER
  CANCELLED_BY_OFFICE
  REJECTED_BY_DRIVER
  DRIVER_ACCEPTED
}

enum TripType {
  CITY_ROUND
  CITY_DROPOFF
  LONG_ROUND
  LONG_DROPOFF
}

enum UserRole {
  ADMIN
  MANAGER
  OFFICE_STAFF
  DRIVER
  STAFF
  CUSTOMER
}

enum FranchiseStatus {
  ACTIVE
  BLOCKED
  TEMPORARILY_CLOSED
}

enum ComplaintStatus {
  RECEIVED // Newly registered complaint
  IN_PROCESS // Complaint being processed
  RESOLVED // Complaint resolved
}

enum ComplaintPriority {
  LOW
  MEDIUM
  HIGH
}

enum ComplaintResolutionAction {
  WARNING // Issued warning; 3+ warnings auto-fire
  FIRE    // Fired; cannot login or register
}

enum WarningPriority {
  LOW
  MEDIUM
  HIGH
}

enum AttendanceStatus {
  PRESENT
  PARTIAL
  ABSENT
  LATE
  HALF_DAY
  ON_LEAVE
}

enum LeaveType {
  SICK_LEAVE
  CASUAL_LEAVE
  EARNED_LEAVE
  EMERGENCY_LEAVE
  OTHER
}

enum LeaveRequestStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
}

model DriverRating {
  id                 String   @id @default(uuid()) @db.Uuid
  driverId           String   @db.Uuid
  tripId             String?  @db.Uuid
  customerName       String
  customerPhone      String
  customerEmail      String?
  // Rating fields
  overallRating      Float // Overall rating (1-5)
  experience         String? // How was experience (text feedback)
  drivingSafety      Float // Safety rating (1-5)
  drivingSmoothness  Float // Smoothness rating (1-5)
  behaviorPoliteness Float // Politeness rating (1-5)
  // Metadata
  isVerified         Boolean  @default(false) // Whether rating is verified
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  Driver             Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)
  Trip               Trip?    @relation(fields: [tripId], references: [id], onDelete: SetNull)

  @@index([driverId])
  @@index([tripId])
  @@index([createdAt])
}

model TripReview {
  id            String   @id @default(uuid()) @db.Uuid
  tripId        String   @db.Uuid
  driverId      String   @db.Uuid
  franchiseId   String   @db.Uuid
  customerId    String   @db.Uuid
  tripRating    Int
  overallRating Int
  driverRating  Int
  comment       String
  createdAt     DateTime @default(now())

  Trip       Trip      @relation(fields: [tripId], references: [id], onDelete: Cascade)
  Driver     Driver    @relation(fields: [driverId], references: [id], onDelete: Cascade)
  Franchise  Franchise @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  Customer   Customer  @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([tripId])
  @@index([driverId])
  @@index([customerId])
  @@index([franchiseId])
}

model ActivityLog {
  id          String             @id @default(uuid()) @db.Uuid
  action      ActivityAction
  entityType  ActivityEntityType
  entityId    String? // ID of the related entity (trip, driver, staff, etc.)
  franchiseId String?            @db.Uuid
  driverId    String?            @db.Uuid
  staffId     String?            @db.Uuid
  tripId      String?            @db.Uuid
  userId      String?            @db.Uuid // User who performed the action
  description String
  metadata    Json? // Additional data (old values, new values, etc.)
  latitude    Float?
  longitude   Float?
  createdAt   DateTime           @default(now())
  User        User?              @relation(fields: [userId], references: [id], onDelete: SetNull)
  Franchise   Franchise?         @relation(fields: [franchiseId], references: [id], onDelete: SetNull)
  Driver      Driver?            @relation(fields: [driverId], references: [id], onDelete: SetNull)
  Staff       Staff?             @relation(fields: [staffId], references: [id], onDelete: SetNull)
  Trip        Trip?              @relation(fields: [tripId], references: [id], onDelete: SetNull)

  @@index([franchiseId, createdAt])
  @@index([driverId, createdAt])
  @@index([staffId, createdAt])
  @@index([tripId, createdAt])
  @@index([userId, createdAt])
  @@index([entityType, entityId])
  @@index([action, createdAt])
  @@index([createdAt])
}

enum ActivityAction {
  // Trip actions
  TRIP_CREATED
  TRIP_ASSIGNED
  TRIP_ACCEPTED
  TRIP_REJECTED
  TRIP_STARTED
  TRIP_ENDED
  TRIP_CANCELLED
  TRIP_STATUS_CHANGED
  TRIP_UPDATED
  // Driver actions
  DRIVER_CREATED
  DRIVER_UPDATED
  DRIVER_STATUS_CHANGED
  DRIVER_CLOCK_IN
  DRIVER_CLOCK_OUT
  // Staff actions
  STAFF_CREATED
  STAFF_UPDATED
  STAFF_STATUS_CHANGED
  STAFF_CLOCK_IN
  STAFF_CLOCK_OUT
  // Complaint actions
  COMPLAINT_CREATED
  COMPLAINT_RESOLVED
  COMPLAINT_STATUS_CHANGED
  // Warning actions
  WARNING_ISSUED
  // Leave actions
  LEAVE_REQUESTED
  LEAVE_APPROVED
  LEAVE_REJECTED
  LEAVE_CANCELLED
  // Rating actions
  RATING_SUBMITTED
  // Attendance actions
  ATTENDANCE_RECORDED
  LOGIN
  LOGOUT
  CHECK_IN
  CHECK_OUT
  // Other
  CUSTOMER_CREATED
  CUSTOMER_UPDATED
  FRANCHISE_CREATED
  FRANCHISE_UPDATED
  FRANCHISE_STATUS_CHANGED
}

enum ActivityEntityType {
  TRIP
  DRIVER
  STAFF
  CUSTOMER
  FRANCHISE
  COMPLAINT
  LEAVE_REQUEST
  RATING
  ATTENDANCE
  OTHER
  USER
}

model Penalty {
  id                String              @id @default(uuid()) @db.Uuid
  name              String
  description       String?
  amount            Int                 // Default penalty amount
  type              PenaltyType         @default(PENALTY)
  isActive          Boolean             @default(true)
  
  // Auto-trigger configuration
  isAutomatic       Boolean             @default(false)
  triggerType       PenaltyTriggerType  @default(MANUAL)
  triggerConfig     Json?               // Store conditions like {"delayMinutes": 5, "complaintCount": 3}
  
  // Categorization
  category          PenaltyCategory     @default(OPERATIONAL)
  severity          PenaltySeverity     @default(MEDIUM)
  
  // Notification settings
  notifyAdmin       Boolean             @default(true)
  notifyManager     Boolean             @default(true)
  notifyDriver      Boolean             @default(false)
  
  // Action settings
  blockDriver       Boolean             @default(false)
  
  createdAt         DateTime            @default(now())
  updatedAt         DateTime            @updatedAt
  
  DriverTransactions DriverTransaction[]

  @@index([isActive])
  @@index([type])
  @@index([triggerType])
  @@index([category])
  @@index([severity])
}

enum PenaltyType {
  PENALTY // Deduction for violations
  DEDUCTION // Standard deductions (fuel, maintenance, etc.)
}

enum PenaltyTriggerType {
  MANUAL
  LATE_REPORT
  THREE_COMPLAINTS
  CANCELLED_TRIP
  PHONE_NOT_ANSWERED
  DRESS_CODE_VIOLATION
  CUSTOMER_COMPLAINT
}

enum PenaltyCategory {
  OPERATIONAL
  BEHAVIORAL
  FINANCIAL
  SAFETY
}

enum PenaltySeverity {
  LOW
  MEDIUM
  HIGH
}

// Driver Daily Metrics - Historical daily snapshots of driver performance
model DriverDailyMetrics {
  id                    String   @id @default(uuid()) @db.Uuid
  driverId              String   @db.Uuid
  date                  DateTime @db.Date // Date for which metrics are recorded
  
  // Trip metrics
  numberOfTrips         Int      @default(0)
  numberOfComplaints    Int      @default(0)
  distanceTraveled      Decimal  @default(0) @db.Decimal(10, 2) // in km
  
  // Rating metrics
  tripAverageRating     Float?   // Average rating for trips on this date
  overallRating         Float?   // Overall driver rating at end of day
  
  // Financial metrics
  dailyLimit            Decimal? @db.Decimal(10, 2)
  remainingLimit        Decimal? @db.Decimal(10, 2)
  incentive             Decimal? @db.Decimal(10, 2)
  bonus                 Decimal? @db.Decimal(10, 2)
  cashInHand            Decimal  @default(0) @db.Decimal(10, 2)
  cashSubmittedOnDate   Decimal  @default(0) @db.Decimal(10, 2) // Cash submitted to branch on this date
  
  // Metadata
  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt
  
  Driver                Driver   @relation(fields: [driverId], references: [id], onDelete: Cascade)

  @@unique([driverId, date]) // One record per driver per day
  @@index([driverId, date])
  @@index([date])
}

// Trip Status History - Complete lifecycle tracking for trips
enum TripEventType {
  ARRIVED_ON_LOCATION
  TRIP_INITIATED
  TRIP_STARTED
  TRIP_LOCATION_REACHED
  TRIP_DESTINATION_REACHED
  TRIP_END_INITIATED
  TRIP_ENDED
  TRIP_AMOUNT_COLLECTED
  PAYMENT_COLLECTED
  PAYMENT_SUBMITTED_TO_BRANCH
  STATUS_CHANGED
}

model TripStatusHistory {
  id            String        @id @default(uuid()) @db.Uuid
  tripId        String        @db.Uuid
  driverId      String?       @db.Uuid
  eventType     TripEventType
  status        TripStatus?   // Trip status at time of event
  description   String?       // Additional details
  metadata      Json?         // Additional data (location, amount, coordinates, etc.)
  occurredAt    DateTime      @default(now())
  createdBy     String?       @db.Uuid // User/driver who triggered the event
  
  Trip          Trip          @relation(fields: [tripId], references: [id], onDelete: Cascade)
  Driver        Driver?       @relation(fields: [driverId], references: [id], onDelete: SetNull)
  User          User?         @relation(fields: [createdBy], references: [id], onDelete: SetNull)

  @@index([tripId, occurredAt])
  @@index([driverId, occurredAt])
  @@index([eventType, occurredAt])
  @@index([occurredAt])
}

// Driver Transactions - Track all earnings and deductions for drivers
enum TransactionType {
  CREDIT
  DEBIT
}

enum DriverTransactionType {
  PENALTY
  TRIP
  GIFT
}

model DriverTransaction {
  id              String                 @id @default(uuid()) @db.Uuid
  driverId        String                 @db.Uuid
  amount          Decimal                @db.Decimal(10, 2)
  transactionType TransactionType        // CREDIT or DEBIT
  tripId          String?                @db.Uuid // Optional, null for penalties
  type            DriverTransactionType  // PENALTY, TRIP, or GIFT
  description     String?                // Optional description
  
  // Penalty tracking fields
  penaltyId       String?                @db.Uuid // Reference to Penalty master
  appliedBy       String?                @db.Uuid // User who applied manual penalty
  metadata        Json?                  // Store trigger details, before/after balance
  
  createdAt       DateTime               @default(now())
  updatedAt       DateTime               @updatedAt
  
  Driver          Driver                 @relation(fields: [driverId], references: [id], onDelete: Cascade)
  Trip            Trip?                  @relation(fields: [tripId], references: [id], onDelete: SetNull)
  Penalty         Penalty?               @relation(fields: [penaltyId], references: [id], onDelete: SetNull)
  AppliedByUser   User?                  @relation("AppliedTransactions", fields: [appliedBy], references: [id], onDelete: SetNull)

  @@index([driverId, createdAt])
  @@index([transactionType])
  @@index([type])
  @@index([tripId])
  @@index([penaltyId])
  @@index([appliedBy])
}
