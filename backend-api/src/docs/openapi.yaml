openapi: 3.0.0
info:
  title: Drybros Backend API
  version: 0.0.1
  description: API documentation for Drybros backend

servers:
  - url: http://localhost:3000

paths:
  /health:
    get:
      summary: Health check
      responses:
        "200":
          description: API health status

  /version:
    get:
      summary: Version info
      responses:
        "200":
          description: App version info

  /franchises:
    get:
      summary: List all franchises
      responses:
        "200":
          description: List of franchises

  /franchises/{id}:
    get:
      summary: Get franchise by ID
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Franchise data
        "404":
          description: Franchise not found

  /customers:
    post:
      summary: Create a customer
      tags:
        - Customers
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateCustomerRequest"
      responses:
        "201":
          description: Customer created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CustomerResponse"

  /trips:
    post:
      summary: Create a trip
      tags:
        - Trips
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateTripRequest"
      responses:
        "201":
          description: Trip created
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TripResponse"

  /trips/{id}/driver-accept:
    patch:
      summary: Driver accepts a trip
      tags:
        - Trips
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                driverId:
                  type: integer
              required:
                - driverId
      responses:
        "200":
          description: Trip accepted by driver
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TripResponse"

  /trips/{id}/driver-reject:
    patch:
      summary: Driver rejects a trip
      tags:
        - Trips
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                driverId:
                  type: integer
              required:
                - driverId
      responses:
        "200":
          description: Trip rejected by driver
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TripResponse"

  /trips/{id}/generate-start-otp:
    post:
      summary: Generate start OTP for a trip
      tags:
        - Trips
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                driverId:
                  type: integer
              required:
                - driverId
      responses:
        "200":
          description: Start OTP generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/StartOtpResponse"

  /trips/{id}/start:
    patch:
      summary: Start trip with OTP
      tags:
        - Trips
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/StartTripRequest"
      responses:
        "200":
          description: Trip started
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TripResponse"

  /trips/{id}/generate-end-otp:
    post:
      summary: Generate end OTP for a trip
      tags:
        - Trips
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              type: object
              properties:
                driverId:
                  type: integer
              required:
                - driverId
      responses:
        "200":
          description: End OTP generated
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/EndOtpResponse"

  /trips/{id}/end:
    patch:
      summary: End trip with OTP and payment
      tags:
        - Trips
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/EndTripRequest"
      responses:
        "200":
          description: Trip completed
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/TripResponse"

  /drivers:
    get:
      summary: List all drivers
      tags:
        - Drivers
      security:
        - bearerAuth: []
      responses:
        "200":
          description: List of drivers
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: "#/components/schemas/Driver"
    post:
      summary: Create a new driver
      description: |
        Create a new driver. Only ADMIN and OFFICE_STAFF roles can create drivers.
        A driver code will be auto-generated and a welcome email will be sent with login credentials.
      tags:
        - Drivers
      security:
        - bearerAuth: []
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: "#/components/schemas/CreateDriverRequest"
      responses:
        "201":
          description: Driver created successfully
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/CreateDriverResponse"
        "400":
          description: Bad request - validation error
        "409":
          description: Conflict - phone or email already exists
        "401":
          description: Unauthorized
        "403":
          description: Forbidden - insufficient permissions

  /drivers/{id}:
    get:
      summary: Get driver by ID
      tags:
        - Drivers
      security:
        - bearerAuth: []
      parameters:
        - name: id
          in: path
          required: true
          schema:
            type: integer
      responses:
        "200":
          description: Driver data
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    $ref: "#/components/schemas/Driver"
        "404":
          description: Driver not found

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
  schemas:
    CreateCustomerRequest:
      type: object
      properties:
        fullName:
          type: string
        phone:
          type: string
        email:
          type: string
        city:
          type: string
        notes:
          type: string
        franchiseId:
          type: integer
      required:
        - fullName
        - phone
        - franchiseId

    Customer:
      type: object
      properties:
        id:
          type: integer
        fullName:
          type: string
        phone:
          type: string
        email:
          type: string
        city:
          type: string
        notes:
          type: string
        franchiseId:
          type: integer

    CustomerResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/Customer"

    CreateTripRequest:
      type: object
      properties:
        franchiseId:
          type: integer
        driverId:
          type: integer
        customerId:
          type: integer
        tripType:
          type: string
          enum: [CITY_ROUND, CITY_DROPOFF, LONG_ROUND, LONG_DROPOFF]
        pickupLocation:
          type: string
        dropLocation:
          type: string
        scheduledAt:
          type: string
          format: date-time
        baseAmount:
          type: number
        extraAmount:
          type: number
      required:
        - franchiseId
        - driverId
        - customerId
        - tripType
        - pickupLocation
        - baseAmount

    Trip:
      type: object
      properties:
        id:
          type: integer
        franchiseId:
          type: integer
        driverId:
          type: integer
          nullable: true
        customerId:
          type: integer
        customerName:
          type: string
        customerPhone:
          type: string
        tripType:
          type: string
        status:
          type: string
        pickupLocation:
          type: string
        dropLocation:
          type: string
          nullable: true
        scheduledAt:
          type: string
          format: date-time
          nullable: true
        startedAt:
          type: string
          format: date-time
          nullable: true
        endedAt:
          type: string
          format: date-time
          nullable: true
        baseAmount:
          type: number
        extraAmount:
          type: number
        totalAmount:
          type: number
        finalAmount:
          type: number
        paymentStatus:
          type: string
        paymentMode:
          type: string
          nullable: true
        paymentReference:
          type: string
          nullable: true

    TripResponse:
      type: object
      properties:
        data:
          $ref: "#/components/schemas/Trip"

    StartOtpResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            tripId:
              type: integer
            otp:
              type: string

    EndOtpResponse:
      type: object
      properties:
        data:
          type: object
          properties:
            tripId:
              type: integer
            otp:
              type: string

    StartTripRequest:
      type: object
      properties:
        driverId:
          type: integer
        otp:
          type: string
      required:
        - driverId
        - otp

    EndTripRequest:
      type: object
      properties:
        driverId:
          type: integer
        otp:
          type: string
        finalAmount:
          type: number
        paymentStatus:
          type: string
          enum: [PENDING, PAID, PARTIALLY_PAID]
        paymentMode:
          type: string
          enum: [CASH, UPI, CARD, OTHER]
        paymentReference:
          type: string
        overrideReason:
          type: string
      required:
        - driverId
        - otp
        - finalAmount
        - paymentStatus
        - paymentMode

    CreateDriverRequest:
      type: object
      properties:
        firstName:
          type: string
          description: Driver's first name
        lastName:
          type: string
          description: Driver's last name
        phone:
          type: string
          description: Primary phone number (must be unique)
        email:
          type: string
          format: email
          description: Email address (must be unique)
        altPhone:
          type: string
          description: Alternate phone number (optional)
        password:
          type: string
          minLength: 6
          description: Password for web login (auto-generated from frontend)
        emergencyContactName:
          type: string
          description: Emergency contact person's name
        emergencyContactPhone:
          type: string
          description: Emergency contact phone number
        emergencyContactRelation:
          type: string
          description: Relationship with emergency contact
        address:
          type: string
          description: Street address
        city:
          type: string
          description: City
        state:
          type: string
          description: State
        pincode:
          type: string
          minLength: 6
          description: Postal/ZIP code
        licenseNumber:
          type: string
          description: Driving license number
        licenseExpDate:
          type: string
          format: date-time
          description: License expiration date (must be in future)
        bankAccountName:
          type: string
          description: Bank account holder name
        bankAccountNumber:
          type: string
          description: Bank account number
        bankIfscCode:
          type: string
          description: Bank IFSC code
        aadharCard:
          type: boolean
          default: false
          description: Aadhar card collected
        license:
          type: boolean
          default: false
          description: License document collected
        educationCert:
          type: boolean
          default: false
          description: Education certificate collected
        previousExp:
          type: boolean
          default: false
          description: Previous experience certificate collected
        carTypes:
          type: array
          items:
            type: string
            enum: [MANUAL, AUTOMATIC, PREMIUM_CARS, LUXURY_CARS, SPORTY_CARS]
          minItems: 1
          description: Types of cars the driver can drive
        franchiseId:
          type: integer
          description: Franchise ID (for now use dummy UUID as integer)
      required:
        - firstName
        - lastName
        - phone
        - email
        - password
        - emergencyContactName
        - emergencyContactPhone
        - emergencyContactRelation
        - address
        - city
        - state
        - pincode
        - licenseNumber
        - licenseExpDate
        - bankAccountName
        - bankAccountNumber
        - bankIfscCode
        - carTypes
        - franchiseId

    Driver:
      type: object
      properties:
        id:
          type: integer
        franchiseId:
          type: integer
        firstName:
          type: string
        lastName:
          type: string
        phone:
          type: string
        email:
          type: string
        altPhone:
          type: string
          nullable: true
        driverCode:
          type: string
          description: Auto-generated unique driver code for app login
        emergencyContactName:
          type: string
        emergencyContactPhone:
          type: string
        emergencyContactRelation:
          type: string
        address:
          type: string
        city:
          type: string
        state:
          type: string
        pincode:
          type: string
        licenseNumber:
          type: string
        licenseExpDate:
          type: string
          format: date-time
        bankAccountName:
          type: string
        bankAccountNumber:
          type: string
        bankIfscCode:
          type: string
        aadharCard:
          type: boolean
        license:
          type: boolean
        educationCert:
          type: boolean
        previousExp:
          type: boolean
        carTypes:
          type: array
          items:
            type: string
            enum: [MANUAL, AUTOMATIC, PREMIUM_CARS, LUXURY_CARS, SPORTY_CARS]
        status:
          type: string
          enum: [ACTIVE, INACTIVE, BLOCKED, TERMINATED]
        complaintCount:
          type: integer
        bannedGlobally:
          type: boolean
        dailyTargetAmount:
          type: integer
          nullable: true
        currentRating:
          type: number
          nullable: true
        createdBy:
          type: integer
          nullable: true
          description: User ID who created this driver
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateDriverResponse:
      type: object
      properties:
        message:
          type: string
          example: "Driver created successfully"
        data:
          $ref: "#/components/schemas/Driver"
