generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Customer {
  id          Int       @id @default(autoincrement())
  fullName    String
  phone       String    @unique
  email       String?
  city        String?
  notes       String?
  franchiseId String   @db.Uuid
  createdAt   DateTime  @default(now())
  updatedAt   DateTime
  Franchise   Franchise @relation(fields: [franchiseId], references: [id])
  Trip        Trip[]
}

model DistanceScope {
  id             String              @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name           String
  description    String?
  status         DistanceScopeStatus @default(ACTIVE)
  createdAt      DateTime            @default(now())
  updatedAt      DateTime
  TripTypeConfig TripTypeConfig[]
}

model Driver {
  id                String       @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  franchiseId       String       @db.Uuid
  firstName         String
  lastName          String
  phone             String       @unique
  email             String       @unique
  altPhone          String?
  driverCode        String       @unique
  password          String       // hashed password for web login
  emergencyContactName      String
  emergencyContactPhone     String
  emergencyContactRelation  String
  address          String
  city             String
  state            String
  pincode          String
  licenseNumber    String
  licenseExpDate   DateTime
  bankAccountName  String
  bankAccountNumber String
  bankIfscCode     String
  aadharCard       Boolean      @default(false)
  license          Boolean      @default(false)
  educationCert    Boolean      @default(false)
  previousExp      Boolean      @default(false)
  carTypes         String       // JSON array of CarType enum values
  status           DriverStatus @default(ACTIVE)
  complaintCount   Int          @default(0)
  bannedGlobally   Boolean      @default(false)
  dailyTargetAmount Int?
  currentRating     Float?
  isActive         Boolean      @default(true)
  createdBy        String?      @db.Uuid // User ID who created this driver
  createdAt        DateTime     @default(now())
  updatedAt        DateTime     @updatedAt
  Trip             Trip[]
}

model Franchise {
  id            String     @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  code          String     @unique
  name          String
  city          String      // Keep for backward compatibility
  region        String?     // New field
  address       String?     // Physical address
  phone         String?     // Contact number
  inchargeName  String?     // Incharge name
  storeImage    String?     // Store image URL (optional)
  legalDocumentsCollected Boolean @default(false) // Legal documents collected flag
  status        FranchiseStatus @default(ACTIVE) // Franchise status
  isActive      Boolean    @default(true)
  createdAt     DateTime   @default(now())
  updatedAt     DateTime   @updatedAt
  Customer      Customer[]
  // Driver relation commented out temporarily to allow dummy UUIDs
  // Driver    Driver[]
  Trip          Trip[]
}

model Role {
  name        String   @unique
  description String?
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
}

model Staff {
  id                       String         @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name                     String
  phone                    String         @unique
  password                 String
  franchiseId              String         @db.Uuid
  monthlySalary            Decimal        @db.Decimal(10, 2)
  address                  String
  emergencyContact         String
  emergencyContactRelation String
  profilePic               String?
  isActive                 Boolean        @default(true)
  createdAt                DateTime       @default(now())
  updatedAt                DateTime
  govtId                   Boolean        @default(false)
  addressProof             Boolean        @default(false)
  certificates             Boolean        @default(false)
  previousExperienceCert   Boolean        @default(false)
  email                    String         @unique
  status                   StaffStatus    @default(ACTIVE)
  suspendedUntil           DateTime?
  joinDate                 DateTime       @default(now())
  relieveDate              DateTime?
  relieveReason            RelieveReason?
  StaffHistory             StaffHistory[]

  @@index([franchiseId, isActive])
  @@index([franchiseId, status])
}

model StaffHistory {
  id          String   @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  staffId     String   @db.Uuid
  action      String
  description String?
  changedBy   String?
  oldValue    String?
  newValue    String?
  createdAt   DateTime @default(now())
  Staff       Staff    @relation(fields: [staffId], references: [id], onDelete: Cascade)

  @@index([createdAt])
  @@index([staffId])
}

model Trip {
  franchiseId          String        @db.Uuid
  driverId             String?       @db.Uuid
  customerId           Int?
  customerName         String
  customerPhone        String
  tripType             TripType
  status               TripStatus    @default(REQUESTED)
  pickupLocation       String
  dropLocation         String?
  scheduledAt          DateTime?
  startedAt            DateTime?
  endedAt              DateTime?
  startOtp             String?
  endOtp               String?
  baseAmount           Int
  extraAmount          Int           @default(0)
  totalAmount          Int
  finalAmount          Int
  isAmountOverridden   Boolean       @default(false)
  overrideReason       String?
  paymentStatus        PaymentStatus @default(PENDING)
  paymentMode          PaymentMode?
  paymentReference     String?
  createdAt            DateTime      @default(now())
  updatedAt            DateTime
  alternativePhone     String?
  carType              String?
  customerEmail        String?
  dropLocationNote     String?
  isDetailsReconfirmed Boolean       @default(false)
  isFareDiscussed      Boolean       @default(false)
  isPriceAccepted      Boolean       @default(false)
  pickupLocationNote   String?
  id                   String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  tripPlacedDate       DateTime      @default(now())
  createdBy            String?       @db.Uuid
  dropAddress          String?
  pickupAddress        String?
  User                 User?         @relation(fields: [createdBy], references: [id])
  Customer             Customer?     @relation(fields: [customerId], references: [id])
  Driver               Driver?       @relation(fields: [driverId], references: [id])
  Franchise            Franchise     @relation(fields: [franchiseId], references: [id])
}

model TripPattern {
  id             String            @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name           String
  description    String?
  createdAt      DateTime          @default(now())
  updatedAt      DateTime
  status         TripPatternStatus @default(ACTIVE)
  TripTypeConfig TripTypeConfig[]
}

model TripTypeConfig {
  id               String        @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  name             String        // e.g., "CITY_ROUND", "CITY_DROPOFF"
  description      String?
  distanceScopeId  String        @db.Uuid
  tripPatternId    String        @db.Uuid
  
  // Base pricing
  basePrice        Float         // Base price (₹400, ₹500, etc.)
  basePricePerHour Float?        // Base price per hour (kept for backward compatibility)
  baseDuration     Float?        // Base duration in hours (3h, 2h)
  baseDistance     Float?        // Base distance in km (20 km)
  
  // Extra charges
  extraPerHour     Float         @default(0)  // ₹100 per hour
  extraPerHalfHour Float?        // ₹50 per 30 min (for CITY_DROPOFF)
  extraPerKm       Float?        // For distance-based pricing
  
  // Premium car pricing (overrides base)
  premiumCarMultiplier Float?    // e.g., 1.5x or separate pricing
  forPremiumCars       Json?      // Separate pricing structure
  
  // Slab-based pricing for LONG_DROPOFF (stored as JSON)
  distanceSlabs       Json?      // [{from: 0, to: 50, price: 1000}, ...]
  
  status             TripTypeConfigStatus @default(ACTIVE)
  createdAt          DateTime    @default(now())
  updatedAt          DateTime    @updatedAt
  
  DistanceScope      DistanceScope @relation(fields: [distanceScopeId], references: [id])
  TripPattern        TripPattern   @relation(fields: [tripPatternId], references: [id])
}

model User {
  email          String    @unique
  password       String
  fullName       String
  role           UserRole
  isActive       Boolean   @default(true)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt
  phone          String?
  id             String    @id @default(dbgenerated("uuid_generate_v4()")) @db.Uuid
  failedAttempts Int       @default(0)
  lockedUntil    DateTime?
  Trip           Trip[]

  @@index([lockedUntil])
}

enum DistanceScopeStatus {
  ACTIVE
  INACTIVE
}

enum CarType {
  MANUAL
  AUTOMATIC
  PREMIUM_CARS
  LUXURY_CARS
  SPORTY_CARS
}

enum DriverStatus {
  ACTIVE
  INACTIVE
  BLOCKED
  TERMINATED
}

enum PaymentMode {
  CASH
  UPI
  CARD
  OTHER
}

enum PaymentStatus {
  PENDING
  PAID
  PARTIALLY_PAID
}

enum RelieveReason {
  RESIGNATION
  TERMINATION
  RETIREMENT
  CONTRACT_ENDED
  PERFORMANCE_ISSUES
  MISCONDUCT
  OTHER
}

enum StaffStatus {
  ACTIVE
  FIRED
  SUSPENDED
  BLOCKED
}

enum TripPatternStatus {
  ACTIVE
  INACTIVE
}

enum TripTypeConfigStatus {
  ACTIVE
  INACTIVE
}

enum TripStatus {
  REQUESTED
  ASSIGNED
  DRIVER_ON_THE_WAY
  IN_PROGRESS
  COMPLETED
  CANCELLED_BY_CUSTOMER
  CANCELLED_BY_OFFICE
  REJECTED_BY_DRIVER
  DRIVER_ACCEPTED
}

enum TripType {
  CITY_ROUND
  CITY_DROPOFF
  LONG_ROUND
  LONG_DROPOFF
}

enum UserRole {
  ADMIN
  MANAGER
  OFFICE_STAFF
  DRIVER
  STAFF
  CUSTOMER
}

enum FranchiseStatus {
  ACTIVE
  BLOCKED
  TEMPORARILY_CLOSED
}
